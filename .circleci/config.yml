version: 2.1
orbs:
  node: circleci/node@4.5.1
  slack: circleci/slack@4.4.2
  aws-cli: circleci/aws-cli@1.4.1
jobs:
  build-docker-images:
    machine:
      image: ubuntu-2004:2022.04.2
    environment:
      DOCKER_REGISTRY: cvisionai
    steps:
    - attach_workspace:
        at: ~/
    - run:
        name: Install Docker
        command: |
          ssh lightsail 'wget -O get_docker.sh https://get.docker.com';
          ssh lightsail 'chmod +x get_docker.sh';
          ssh lightsail 'VERSION=20.10.23 ./get_docker.sh';
          ssh lightsail 'sudo usermod -aG docker ubuntu';
          ssh lightsail 'docker --version';
    - run:
        name: Add Node repo
        command: |
          ssh lightsail 'curl -sL https://deb.nodesource.com/setup_16.x | sudo -E bash -';
    - run:
        name: Log into Docker Hub
        command: |
          ssh lightsail 'export DOCKER_PASSWORD='"'$DOCKER_PASSWORD'"';export DOCKER_USERNAME='"'$DOCKER_USERNAME'"';echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin';
    - run:
        name: Install packages from apt for build deps (Python3, etc.)
        command: |
          ssh lightsail 'sudo apt-get update && sudo apt-get -y install python3 python3-pip build-essential qemu-user-static binfmt-support nodejs jq';
    - run:
        name: Install pip packages
        command: |
          ssh lightsail 'pip3 install setuptools wheel sphinx-markdown-builder==0.5.5 progressbar2 pyyaml typing-extensions black';
    - run:
        name: Install node packages
        command: |
          ssh lightsail 'cd tator/ui && npm install';
    - run:
        name: Make version.py
        command: |
          ssh lightsail 'cd tator && make api/main/version.py';
    - run:
        name: Make docker images
        command: ssh lightsail 'export APT_REPO_HOST='"'$APT_REPO_HOST'"';cd tator && for i in $(seq 1 3); do make -j$(nproc) tator-image images APT_REPO_HOST=$APT_REPO_HOST && s=0 && break || s=$? && sleep 10; done; (exit $s)'
    - store_artifacts:
        path: doc/_build/schema.yaml
        destination: docs/schema.yaml
    - run:
        name: Install python client
        command: |
          ssh lightsail 'pip3 install tator/scripts/packages/tator-py/dist/*.whl';
    - run:
        name: Generate Markdown Docs
        command: |
          ssh lightsail 'export PATH=$PATH:/home/ubuntu/.local/bin; cd tator && make markdown-docs && tar cf /tmp/tator-py.tar doc/_build/tator-py';
          scp lightsail:/tmp/tator-py.tar /tmp/tator-py.tar;
    - store_artifacts:
        path: /tmp/tator-py.tar
        destination: docs/tator-py.tar
    - run:
        name: Push images to Dockerhub
        command: |
          ssh lightsail 'export DOCKERHUB_PASSWORD='"'$DOCKERHUB_PASSWORD'"';export DOCKERHUB_USERNAME='"'$DOCKERHUB_USERNAME'"';export CIRCLE_SHA1='"'$CIRCLE_SHA1'"';tator/.circleci/push_dockerhub.sh';
  set-versions:
    machine:
      image: ubuntu-2004:202010-01
    steps:
    - attach_workspace:
        at: ~/
    - run:
        name: Set version in tator-py, tator-js, and REST interface
        command: |
          ssh lightsail 'export TATOR_VERSION='"'$CIRCLE_TAG'"';sed -i "s/DEVELOPMENT_VERSION/$TATOR_VERSION/g" tator/scripts/packages/tator-py/config.json';
          ssh lightsail 'export TATOR_VERSION='"'$CIRCLE_TAG'"';sed -i "s/DEVELOPMENT_VERSION/$TATOR_VERSION/g" tator/scripts/packages/tator-js/config.json';
          ssh lightsail 'export TATOR_VERSION='"'$CIRCLE_TAG'"';sed -i "s/DEVELOPMENT_VERSION/$TATOR_VERSION/g" tator/api/main/urls.py';
  publish-clients:
    machine:
      image: ubuntu-2004:202010-01
    steps:
    - attach_workspace:
        at: ~/
    - run:
        name: Publish tator-py
        command: |
          ssh lightsail 'pip3 install twine';
          ssh lightsail 'export TWINE_USERNAME='"'$TWINE_USERNAME'"';export TWINE_PASSWORD='"'$TWINE_PASSWORD'"';export TWINE_NON_INTERACTIVE='"'$TWINE_NON_INTERACTIVE'"';cd tator/scripts/packages/tator-py && python3 -m twine upload dist/*';
    - run:
        name: Publish tator-js
        command: |
          ssh lightsail 'export NPM_TOKEN='"'$NPM_TOKEN'"';cd tator/scripts/packages/tator-js/pkg && npm set "//registry.npmjs.org/:_authToken" $NPM_TOKEN && npm publish';
  check-formatting:
    machine:
      image: ubuntu-2004:202010-01
    steps:
    - checkout
    - run:
        name: Initialize submodules
        command: git submodule update --init --recursive
    - run:
        name: Install packages from apt for build deps (Python3, etc.)
        command: |
          sudo apt-get update && sudo apt-get -y install python3 python3-pip build-essential qemu-user-static binfmt-support nodejs jq
    - run:
        name: Install pip packages
        command: |
          pip3 install black==23.3.0
    - run:
        name: Install npm packages
        command: |
          npm install n && n stable && npm install prettier@"2.8.8"
    - run:
        name: Check code formatting
        command: make check-format
  setup-lightsail:
    machine:
      image: ubuntu-2004:202010-01
    steps:
    - checkout
    - run:
        name: Setup lightsail instance
        command: ./scripts/lightsail.sh
    - run:
        name: Tell lightsail to self destruct
        command: |
          ssh lightsail 'curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py';
          ssh lightsail 'python3 get-pip.py';
          ssh lightsail '/home/ubuntu/.local/bin/pip3 install --upgrade awscli';
          echo 'Initiating lightsail self-destruct sequence...';
          ssh lightsail 'export AWS_ACCESS_KEY_ID='"'$AWS_ACCESS_KEY_ID'"';export AWS_SECRET_ACCESS_KEY='"'$AWS_SECRET_ACCESS_KEY'"';export AWS_DEFAULT_REGION='"'$AWS_DEFAULT_REGION'"';export GIT_REVISION='"'$CIRCLE_SHA1'"';sh -c "sleep 10800 && /home/ubuntu/.local/bin/aws lightsail delete-instance --instance-name tator-ci-$GIT_REVISION" >/dev/null 2>&1 &';
          ssh lightsail 'echo "This lightsail instance will self-destruct in 3 hours."';
    - run:
        name: Clone source on lightsail
        command: |
          ssh lightsail 'export CIRCLE_SHA1='"'$CIRCLE_SHA1'"'; sudo rm -fr tator; git clone https://github.com/cvisionai/tator; cd tator && git checkout $CIRCLE_SHA1 && git submodule update --init';
    - persist_to_workspace:
        root: ~/
        paths:
        - .ssh
        - public_ip_address.txt
        - private_ip_address.txt
  install-tator:
    machine:
      image: ubuntu-2004:202010-01
    steps:
    - attach_workspace:
        at: ~/
    - run:
        name: Install test dependencies
        command: |
          ssh lightsail 'wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb';
          ssh lightsail 'sudo -E apt-get -yq --no-install-suggests --no-install-recommends install ./google-chrome-stable_current_amd64.deb';
          ssh lightsail 'sudo -E apt-get update && sudo -E apt-get -yq --no-install-suggests --no-install-recommends install tesseract-ocr python3-pip ffmpeg wget unzip';
          ssh lightsail 'pip3 install pytest pytest-xdist pandas playwright==1.27.1 pytest-playwright==0.3.0 pytesseract==0.3.9 opencv-python pytest-rerunfailures==10.2';
          ssh lightsail 'export PATH=$PATH:$HOME/.local/bin:/snap/bin && playwright install';
          ssh lightsail 'wget http://zebulon.bok.net/Bento4/binaries/Bento4-SDK-1-6-0-632.x86_64-unknown-linux.zip';
          ssh lightsail 'unzip Bento4-SDK-1-6-0-632.x86_64-unknown-linux.zip';
          ssh lightsail 'sudo cp Bento4-SDK-1-6-0-632.x86_64-unknown-linux/bin/mp4dump /usr/local/bin/.';
          ssh lightsail 'sudo chmod +x /usr/local/bin/mp4dump';
          ssh lightsail 'wget https://github.com/mikefarah/yq/releases/download/v4.31.1/yq_linux_amd64 -O /home/ubuntu/.local/bin/yq';
    - run:
        name: Install Tator
        command: |
          ssh lightsail 'cd tator && make tator';
    - run:
        name: Create superuser
        command: |
          ssh lightsail 'cd tator && echo "from main.models import User; User.objects.create_superuser('"'admin'"', password='"'admin'"')" | docker exec -i gunicorn python3 manage.py shell';
    - run:
        name: Copy whl
        command: scp -r lightsail:/home/ubuntu/tator/scripts/packages/tator-py/dist /tmp/tator_py_whl
    - store_artifacts:
        path: /tmp/tator_py_whl
        destination: tator_py_whl
  rest-tests:
    machine:
      image: ubuntu-2004:202010-01
    steps:
    - attach_workspace:
        at: ~/
    - run:
        name: Initialize REST tests
        command: ssh lightsail 'cd tator && make testinit'
    - run:
        name: Run REST tests
        command: ssh lightsail 'cd tator && for i in $(seq 1 3); do make rq-empty && make test && s=0 && break || s=$? && sleep 10; done; (exit $s)'
  front-end-tests:
    machine:
      image: ubuntu-2004:202010-01
    resource_class: xlarge
    steps:
    - attach_workspace:
        at: ~/
    - run:
        name: Copy SSH config
        command: |
          rsync -a --ignore-existing /home/circleci/.ssh/ lightsail:/home/ubuntu/.ssh/;
          ssh lightsail 'sed -i "s/circleci/ubuntu/g" ~/.ssh/config';
    - run:
        name: Install sshfs
        command: sudo -E apt-get update && sudo -E apt-get -yq --no-install-suggests --no-install-recommends install sshfs
    - run:
        name: Front end tests
        no_output_timeout: 30m
        command: |
          ssh lightsail 'cd tator && make rq-empty';
          mkdir -p /tmp/videos;
          ssh lightsail 'mkdir -p /tmp/videos';
          sshfs -o default_permissions lightsail:/tmp/videos /tmp/videos;
          ssh lightsail 'mkdir -p /tmp/videos && export PATH=$PATH:$HOME/.local/bin:/snap/bin && export PYTHONUNBUFFERED=1 && cd tator && for i in $(seq 1 3); do pytest test --slowmo 30 --base-url=http://localhost:8080 --browser=chromium --username=admin --password=admin --videos=/tmp/videos -s && s=0 && break || s=$? && sleep 10; done; (exit $s)';
    - store_artifacts:
        path: /tmp/videos
        destination: videos
  tator-py-tests:
    machine:
      image: ubuntu-2004:202010-01
    steps:
    - attach_workspace:
        at: ~/
    - run:
        name: Copy test directories
        command: |
          ssh lightsail 'rm -rf ~/tator/tatorpy_test && cp -r ~/tator/scripts/packages/tator-py/test ~/tator/tatorpy_test && cp -r ~/tator/scripts/packages/tator-py/examples ~/tator/.';
    - run:
        name: Get API token
        command: |
          ssh lightsail "curl -d '{"'"username"'": "'"admin"'", "'"password"'": "'"admin"'", "'"refresh"'": true}' -H 'Content-Type: application/json' http://localhost:8080/rest/Token | jq '.token' | xargs printf '%b\n' | tee ~/token.txt;"
          scp lightsail:~/token.txt ~/token.txt
    - run:
        name: Run tator-py tests
        command: ssh lightsail 'export TOKEN='"'$(cat ~/token.txt)'"';export PATH=$PATH:$HOME/.local/bin:/snap/bin && cd tator && for i in $(seq 1 3); do pytest tatorpy_test --ignore tatorpy_test/test_algorithm_launch.py --ignore tatorpy_test/test_job_cancel.py --host=http://localhost:8080 --token=$TOKEN -s --keep && s=0 && break || s=$? && sleep 10; done; (exit $s)';
    - run:
        name: Check db-worker logs for clean running
        command: ssh lightsail 'cd tator && make check-clean-db-logs'
    - run:
        name: Dump container logs
        command: |
          ssh lightsail 'cd tator && make dump-logs';
          scp -r lightsail:/tmp/logs /tmp;
        when: always
    - store_artifacts:
        path: /tmp/logs
        destination: container_logs
        when: always
  cron-job-tests:
    machine:
      image: ubuntu-2004:202010-01
    steps:
    - attach_workspace:
        at: ~/
    - run:
        name: Run cron jobs
        command: ssh lightsail 'export PATH=$PATH:$HOME/.local/bin:/snap/bin && ./tator/scripts/test-cronjobs.sh'
  cleanup-lightsail:
    machine:
      image: ubuntu-2004:202010-01
    steps:
    - attach_workspace:
        at: ~/
    - checkout
    - run:
        name: Cleanup lightsail instance
        command: ./scripts/lightsail_cleanup.sh
workflows:
  version: 2
  build-and-test:
    jobs:
    - check-formatting:
        context: cvisionai
        filters:
          tags:
            only: /.*/
    - setup-lightsail:
        requires:
        - check-formatting
        context: cvisionai
        filters:
          tags:
            only: /.*/
    - set-versions:
        requires:
        - setup-lightsail
        context: cd
        filters:
          tags:
            only: /.*/
          branches:
            ignore: /.*/
    - build-docker-images:
        requires:
        - setup-lightsail
        - set-versions
        context: cd
        filters:
          tags:
            only: /.*/
    - publish-clients:
        requires:
        - build-docker-images
        context: cd
        filters:
          tags:
            only: /.*/
          branches:
            ignore: /.*/
    - install-tator:
        requires:
        - build-docker-images
        context: cvisionai
        filters:
          tags:
            only: /.*/
    - rest-tests:
        requires:
        - install-tator
        context: cvisionai
        filters:
          tags:
            only: /.*/
    - tator-py-tests:
        requires:
        - install-tator
        - rest-tests
        context: cvisionai
        filters:
          tags:
            only: /.*/
    - cron-job-tests:
        requires:
        - tator-py-tests
        context: cvisionai
        filters:
          tags:
            only: /.*/
    - front-end-tests:
        requires:
        - rest-tests
        - tator-py-tests
        context: cvisionai
        filters:
          tags:
            only: /.*/
    - cleanup-lightsail:
        requires:
        - rest-tests
        - front-end-tests
        - tator-py-tests
        context: cvisionai
        filters:
          tags:
            only: /.*/
